<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…æ–¹æŸ¥è©¢ (V36.0 - æœ€çµ‚å„ªåŒ–ç‰ˆ)</title>
    <style>
        /* --- Apple é¢¨æ ¼åŸºç¤è¨­å®š --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", sans-serif; 
            background-color: #f2f2f7; padding: 15px; color: #1c1c1e; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
        }
        h2 { color: #1c1c1e; margin-bottom: 25px; font-weight: 700; font-size: 26px; text-align: center; }
        
        /* å€å¡Šé€šç”¨ */
        .section-card { margin-bottom: 30px; border: 1px solid #e5e5ea; border-radius: 12px; padding: 20px; background: #fff; }
        
        /* æœå°‹æ§åˆ¶åˆ— */
        .query-controls-bar {
            display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; 
        }
        .search-input { 
            flex-grow: 1; padding: 12px; font-size: 16px; border-radius: 10px; border: 1px solid #d1d1d6; 
        }

        /* æŒ‰éˆ•æ’ç‰ˆ */
        .part-buttons { flex-grow: 1; display: flex; gap: 5px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        
        #paintInputButtons { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;}
        .btn-part { 
            padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 15px; 
            cursor: pointer; white-space: nowrap; text-align: center; min-width: 70px; flex: 1;
        }
        .btn-part.active { background: #007aff; color: white; border-color: #007aff; }

        /* çµæœè¡¨æ ¼ */
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table th { text-align: left; padding: 10px; background: #f2f2f7; font-size: 13px; color: #555; }
        .result-table td { padding: 10px; border-bottom: 1px solid #eee; font-size: 15px; }
        .highlight-val { color: #007aff; font-weight: 700; }
        .cost-val { color: #ff3b30; font-weight: 600; font-size: 14px; }
        .total-row td { border-top: 2px solid #007aff; font-weight: bold; background-color: #f9f9fd; color: #1c1c1e; }

        /* ç®¡ç†æŒ‰éˆ• */
        .btn-manage { 
            background-color: #34c759; color: white; padding: 12px 25px; border: none; border-radius: 10px; 
            font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px;
        }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 2% auto; padding: 20px; border-radius: 16px; width: 95%; max-width: 950px; max-height: 90vh; overflow-y: auto; }
        
        .tab-group { display: flex; gap: 5px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { padding: 8px 15px; background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; color: #888; font-weight: 600; white-space: nowrap; }
        .tab-btn.active { background: #007aff; color: white; }
        
        /* è¼¸å…¥é …ç›® (æ”¯æ´é‡å·¥æ¬„ä½) */
        .input-row-complex { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 8px 0; border-bottom: 1px dashed #e5e5ea; 
        }
        .input-label { width: 80px; font-weight: 600; font-size: 14px; }
        .input-group-sub { display: flex; gap: 5px; align-items: center; }
        .input-sub-field { width: 70px; padding: 5px; border: 1px solid #d1d1d6; border-radius: 6px; text-align: right; }
        .sub-label { font-size: 12px; color: #888; margin-right: 2px; }
        .rework-rate { font-size: 12px; color: #ff3b30; width: 50px; text-align: right; }

        /* æŒ‰éˆ•çµ„ */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; color: white; }
        .btn-add { background-color: #34c759; } 
        .btn-submit { background-color: #007aff; }
        .btn-modify-save { background-color: #ffc200; color: #1c1c1e;} 
        .btn-clear-daily { background-color: #ff3b30; }

        /* ç®¡ç†è¡¨æ ¼ */
        .manage-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .manage-table th { background: #f2f2f7; padding: 8px; text-align: left; }
        .manage-table td { padding: 8px; border-bottom: 1px solid #eee; }
        
        .comp-blue { color: #007aff; font-weight: 700; }
        
        .cost-input-group { display: flex; gap: 5px; align-items: center; }
        .cost-input { width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>é…æ–¹æŸ¥è©¢ <span style="font-size:14px; color:#888;">(V36.0 Final)</span></h2>

    <div class="section-card">
        <div class="query-controls-bar">
            <span style="font-weight:700; color:#007aff; white-space:nowrap;">é¢æ¼†æŸ¥è©¢</span>
            <input list="paintOptions" id="paintSearchInput" class="search-input" placeholder="è¼¸å…¥æˆ–é¸æ“‡é¢æ¼†å‹è™Ÿ (ä¾‹å¦‚ A8...)" oninput="queryRecipe()">
            <datalist id="paintOptions"></datalist>
        </div>

        <div class="part-buttons" id="partBtnGroup" style="margin-bottom: 20px;"></div>

        <table class="result-table">
            <thead>
                <tr>
                    <th width="35%">é…æ–¹æˆåˆ†</th>
                    <th width="30%">å–®ä»¶ç”¨é‡ (KG)</th>
                    <th width="35%">é ä¼°æˆæœ¬ (NTD)</th>
                </tr>
            </thead>
            <tbody id="recipeResultBody">
                <tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">è«‹è¼¸å…¥å‹è™Ÿä¸¦é¸æ“‡éƒ¨ä»¶</td></tr>
            </tbody>
            <tfoot id="recipeResultFoot" style="display:none;">
                <tr class="total-row">
                    <td>ç¸½è¨ˆæˆæœ¬</td>
                    <td></td>
                    <td id="totalCostDisplay">$0.0</td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <button class="btn-manage" onclick="openManageModal()">âš™ï¸ æ•¸æ“šç®¡ç†ä¸­å¿ƒ</button>
</div>

<!-- Modal -->
<div id="manageModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <span style="font-size:18px; font-weight:bold;">æ•¸æ“šç®¡ç†ä¸­å¿ƒ</span>
            <span onclick="closeModal()" style="cursor:pointer; font-size:20px;">âœ•</span>
        </div>
        
        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('tabInput')">æ¯æ—¥è¼¸å…¥ (å«é‡å·¥)</button>
            <button class="tab-btn" onclick="switchTab('tabHistory')">æ­·å²ç´€éŒ„</button>
            <button class="tab-btn" onclick="switchTab('tabCost')">æˆæœ¬å–®åƒ¹</button>
            <button class="tab-btn" onclick="switchTab('tabPaint')">é¢æ¼†æ¸…å–®</button>
            <button class="tab-btn" onclick="switchTab('tabRule')">è£½ç¨‹è¦å‰‡</button>
            <button class="tab-btn" onclick="switchTab('tabRatio')">åŸºæº–å€ç‡</button>
        </div>

        <!-- æ¯æ—¥è¼¸å…¥ Tab -->
        <div id="tabInput" style="display:block;">
            <div style="text-align:center; margin-bottom:15px; background:#f9f9f9; padding:8px; border-radius:8px;">
                <label>æ—¥æœŸ: </label>
                <input type="date" id="inputDate" style="padding:5px; border:1px solid #ccc; border-radius:4px;">
            </div>

            <div id="paintInputButtons"></div>
            
            <div style="text-align:center; margin-bottom:20px;">
                <label style="font-weight:bold;">ç¸½ä½¿ç”¨é‡ (KG): </label>
                <input type="number" id="in_paint_total" placeholder="0" step="0.01" style="width:100px; padding:6px; border:1px solid #ccc; border-radius:4px;">
            </div>

            <div style="max-width: 600px; margin: 0 auto; border: 1px solid #e5e5ea; border-radius: 8px; padding: 15px;">
                <h4 style="margin:0 0 10px 0; color:#555;">ç”Ÿç”¢æ•¸æ“š</h4> <!-- ITEM 2: Title change -->
                <div id="partInputList"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-add" id="btnAddRecord" onclick="addTodayRecord()">â¬‡ï¸ åŠ å…¥ä»Šæ—¥æ¸…å–®</button>
                <button class="btn btn-modify-save" id="btnUpdateRecord" style="display:none;" onclick="updateModifiedRecord()">ğŸ”„ æ›´æ–°æ­¤ç´€éŒ„</button>
                <button class="btn btn-clear-daily" onclick="clearTodayInput()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>

            <div id="todayListDisplay" style="margin-top:15px; background:#f2f2f7; padding:10px; border-radius:8px; min-height:40px; text-align:center; color:#888;">ä»Šæ—¥å°šæœªåŠ å…¥æ•¸æ“š</div>

            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-submit" style="max-width:300px;" onclick="submitToHistory()">ğŸ”„ ç¢ºèªæ›´æ–°ä¸¦è¨ˆç®—</button>
            </div>
            <div id="statusMessage" style="text-align:center; margin-top:10px; height:20px; font-weight:bold;"></div>
        </div>

        <!-- æ­·å²ç´€éŒ„ Tab -->
        <div id="tabHistory" style="display:none;">
            <div style="max-height:60vh; overflow-y:auto;">
                <table class="manage-table">
                    <thead><tr><th>æ—¥æœŸ</th><th>æ˜ç´°è¡¨</th><th width="100">æ“ä½œ</th></tr></thead> <!-- ITEM 4: Header change -->
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- æˆæœ¬è¨­å®š Tab -->
        <div id="tabCost" style="display:none;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>é…æ–¹å–®åƒ¹</h4> <!-- ITEM 5: Sub-title change -->
                    <table class="manage-table">
                        <thead><tr><th>æˆåˆ†</th><th>å–®åƒ¹ ($/kg)</th></tr></thead>
                        <tbody id="baseCostBody"></tbody>
                    </table>
                </div>
                <div>
                    <h4>é¢æ¼†å–®åƒ¹</h4> <!-- ITEM 5: Sub-title change -->
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input list="paintOptions" id="costPaintName" placeholder="é¸æ“‡æˆ–è¼¸å…¥é¢æ¼†å‹è™Ÿ" style="flex:1; padding:5px; border:1px solid #ddd;">
                        <input type="number" id="costPaintPrice" placeholder="å–®åƒ¹" style="width:70px; padding:5px; border:1px solid #ddd;">
                        <button onclick="addTopcoatPrice()" style="background:#34c759; color:white; border:none; padding:5px 10px; border-radius:4px;">æ–°å¢</button>
                    </div>
                    <div style="max-height:40vh; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table class="manage-table">
                            <thead><tr><th>é¢æ¼†å‹è™Ÿ</th><th>å–®åƒ¹</th><th>åˆªé™¤</th></tr></thead>
                            <tbody id="topcoatCostBody"></tbody>
                        </table>
                    </div>
                    <p style="font-size:12px; color:#666;">* è‹¥æœªè¨­å®šå€‹åˆ¥åƒ¹æ ¼ï¼Œå°‡ä½¿ç”¨å·¦å´ã€Œé¢æ¼†ã€çš„é è¨­å–®åƒ¹ã€‚</p>
                </div>
            </div>
        </div>

        <!-- å…¶ä»– Tabs (æ²¿ç”¨) -->
        <div id="tabPaint" style="display:none;">
            <div style="margin-bottom:10px; display:flex; gap:10px;">
                <input type="text" id="newPaintName" placeholder="æ–°å¢å‹è™Ÿ..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;">
                <button onclick="addPaint()" style="padding:8px 15px; background:#34c759; color:white; border:none; border-radius:5px;">+</button>
            </div>
            <div style="max-height:50vh; overflow-y:auto;">
                <table class="manage-table"><tbody id="paintListBody"></tbody></table>
            </div>
        </div>

        <div id="tabRule" style="display:none;">
            <div style="max-height:60vh; overflow-y:auto;"><table class="manage-table" id="ruleTable"></table></div>
        </div>

        <div id="tabRatio" style="display:none;">
            <table class="manage-table"><tbody id="ratioTableBody"></tbody></table>
        </div>

        <div style="text-align:center; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-submit" style="width:200px;" onclick="saveAllSettings()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
        </div>
    </div>
</div>

<script>
// --- V36.0 è³‡æ–™çµæ§‹ ---
const COMPONENTS = ["ç™½è‰²", "ç°è‰²", "é»‘è‰²", "TAP", "æ±é‚¦0.1", "æ±é‚¦0.2", "é‡‘æ²¹", "é¢æ¼†"];
const DEFAULT_PARTS = {"è»Šæ¶":1.0, "å‰å‰":0.5, "å¾Œä¸Šä¸‹å‰":0.5, "å‰ä¸‰è§’é›»":1.3, "å‰ä¸‰è§’":0.8, "å¾Œä¸‰è§’":0.5, "è»Šåœˆ":0.5, "è“‹è²¨æ¶":0.3, "é…ä»¶":0.3};

// V33 é¢æ¼†æ¸…å–® (ç¸®æ¸›ç‰ˆç¤ºæ„ï¼Œå¯¦éš›æœƒè¼‰å…¥å®Œæ•´ç‰ˆ)
const DEFAULT_PAINTS = [
    "A153F","A119F","A225T","A242t","A266W","A268W","A291F","A304Z","A310F","A312F","A335Z","A482F","A515W","A618W","A638W","A641Z","A690T","A756Z","A852Z","A875t","A876Z","A878F","A883F","A930F","A993F","A996F","A804t","A801F","A990W",
    "B06F","B05Z","B07F","B04t-0.2","B100F","B127Z","B127Zä¸­","B133I","B133Iä¸­åº•","B249F","B273Iä¸­åº•","B328F","B454Z","B467Z","B536I","B579Z","B663t","B642Wä¸­","B731Z","B751Z","B753Z","B772W","B884I","B894R","B918F","B919F","B923t","B978R","B982F","B933F",
    "C207Z","C512N0.1","C583R","C732W","C786I ä¸­åº•","C786I é¢æ¼†","C211W","C844t","C882t","C895t","C995Z ä¸­åº•","C995Z",
    "G199t","G03t","G209I","G82t","G215Z","G215B","G03F","G232W","G244t","G246F","G303F","G311Z","G313B","G248F","G314Z","G315Z","G320Z","G321I","G323Z","G329W","G455Z","G463t","G486I","G498B","G580F","G590Z","G600F","G609t","G706R","G706Rä¸­","G710W","G770I","G771W","G885F","G866F","G915F","G916Xä¸­","G916Xé¢",
    "K704t","K01C","K144P","K376t","8900C","O333F","O189F","O402F","O480I","O485F","O546Z","O932F",
    "R89I","R191F","R243W","R326W","R253F","R270I","R298W","R293F","R322W","R447I","R459Z","R470I","R461I","R532I","R532Iä¸­","R611Bä¸­","R611B","R635Xä¸­","R635X","R470Iä¸­","R880I","R886Z","R887Iä¸­","R887I","R934F","R981F",
    "S443Z","S352T","S437W","S612Z","S746S","TC-21036","TC-24045","TC-24028","V238B","V200I","V324I","V458Z","V627R","V713W",
    "W210Iä¸­åº•","W210I","W14F","W214I","W300C","W327F","W348I","W650t","W700I","W806Iä¸­","W806I","W780F",
    "Y316I","Y247F","Y319Z","Y535F","Y774F", "A846F","B169t","B847","B849","B860t","B867t","G856","O588F","S859Z","V845F","W853Z"
];
const RULE_CATS = ["A", "B", "C", "G", "K", "O", "R", "S", "V", "W", "Y", "8"];
const RULE_CODES = ["F", "T", "t", "W", "Z", "I", "B", "R", "C", "S", "X", "P"];

// ç‹€æ…‹è®Šæ•¸
let partRatios = {};
let paintList = [];
let ruleTable = []; 
let historicalData = []; 
let baseCosts = {}; // é€šç”¨æˆåˆ†æˆæœ¬
let topcoatCosts = {}; // é¢æ¼†å€‹åˆ¥æˆæœ¬
let calculatedBaseFormula = {};
let todayTempList = [];
let currentPart = "è»Šæ¶"; 
let currentBatchComponent = ''; 
let modifyingIndex = -1; 

function init() {
    // è¼‰å…¥ localStorage
    partRatios = JSON.parse(localStorage.getItem('V35_Ratios')) || DEFAULT_PARTS;
    let savedPaints = JSON.parse(localStorage.getItem('V35_PaintList'));
    paintList = (savedPaints && savedPaints.length > 50) ? savedPaints : DEFAULT_PAINTS.slice().sort();
    
    // æ­·å²è³‡æ–™é·ç§» (æ”¯æ´ V34 æ ¼å¼)
    historicalData = JSON.parse(localStorage.getItem('V35_History')) || [];
    if(historicalData.length === 0 && localStorage.getItem('V34_History')) {
        let old = JSON.parse(localStorage.getItem('V34_History'));
        // èˆŠè³‡æ–™æ²’æœ‰ rework æ¬„ä½ï¼Œè£œä¸Šç©ºç‰©ä»¶
        historicalData = old.map(r => ({...r, partRework: r.partRework || {}}));
    }

    ruleTable = JSON.parse(localStorage.getItem('V35_Rules')) || generateDefaultRules();
    
    // æˆæœ¬è¼‰å…¥
    baseCosts = JSON.parse(localStorage.getItem('V35_BaseCosts')) || {};
    COMPONENTS.forEach(c => { if(baseCosts[c] === undefined) baseCosts[c] = 300; });
    topcoatCosts = JSON.parse(localStorage.getItem('V35_TopcoatCosts')) || {};

    document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
    recalculateFormula(); 
    renderQueryControls();
    
    document.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });
}

function generateDefaultRules() {
    let rules = [];
    RULE_CATS.forEach(cat => {
        RULE_CODES.forEach(code => {
            let recipe = {};
            COMPONENTS.forEach(c => recipe[c] = false);
            if(cat === 'A' && ['F','T'].includes(code)) { recipe['ç°è‰²'] = true; recipe['TAP'] = true; recipe['é¢æ¼†'] = true; }
            rules.push({ cat, code, recipe });
        });
    });
    return rules;
}

/* --- æ¯æ—¥è¼¸å…¥ (å«é‡å·¥é‚è¼¯) --- */
function renderInputFields() {
    document.getElementById('paintInputButtons').innerHTML = COMPONENTS.map(c => `
        <button class="btn-part ${c===currentBatchComponent?'active':''}" onclick="selectBatchComponent('${c}')">${c}</button>
    `).join('');

    const partDiv = document.getElementById('partInputList');
    // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“æˆ–åˆ‡æ›æˆåˆ†ï¼Œé‡æ–°ç”Ÿæˆçµæ§‹
    if(!partDiv.innerHTML || partDiv.children.length !== Object.keys(partRatios).length) {
        partDiv.innerHTML = Object.keys(partRatios).map(p => `
            <div class="input-row-complex">
                <div class="input-label">${p}</div>
                <div class="input-group-sub">
                    <span class="sub-label">ç”Ÿç”¢</span>
                    <input type="number" id="in_prod_${p}" class="input-sub-field" placeholder="0" oninput="calcReworkRate('${p}')">
                </div>
                <div class="input-group-sub">
                    <span class="sub-label">é‡å·¥</span>
                    <input type="number" id="in_rework_${p}" class="input-sub-field" placeholder="0" oninput="calcReworkRate('${p}')">
                </div>
                <div class="rework-rate" id="rate_${p}">0%</div>
            </div>
        `).join('');
    }
    
    const isEdit = modifyingIndex >= 0;
    document.getElementById('btnAddRecord').style.display = isEdit ? 'none' : 'block';
    document.getElementById('btnUpdateRecord').style.display = isEdit ? 'block' : 'none';
}

function selectBatchComponent(c) {
    currentBatchComponent = c;
    // ä¿æŒè¼¸å…¥æ¡†æ•¸å€¼ä¸è®Šï¼Œåªæ›´æ–°æŒ‰éˆ•ç‹€æ…‹
    document.querySelectorAll('#paintInputButtons .btn-part').forEach(b => {
        b.classList.toggle('active', b.innerText === c);
    });
}

function calcReworkRate(part) {
    const prod = parseFloat(document.getElementById(`in_prod_${part}`).value) || 0;
    const rework = parseFloat(document.getElementById(`in_rework_${part}`).value) || 0;
    const rateDiv = document.getElementById(`rate_${part}`);
    
    if (prod > 0) {
        const rate = (rework / prod) * 100;
        rateDiv.innerText = rate.toFixed(1) + '%';
        rateDiv.style.color = rate > 10 ? 'red' : (rate > 0 ? '#ff9500' : '#ccc');
    } else {
        rateDiv.innerText = rework > 0 ? '100%' : '0%';
    }
}

function addTodayRecord() {
    if (modifyingIndex >= 0) { showStatus("âš ï¸ è«‹å…ˆé€€å‡ºä¿®æ”¹æ¨¡å¼", "red"); return; }
    if (!currentBatchComponent) { showStatus("âš ï¸ è«‹é¸æ“‡æˆåˆ†", "red"); return; }
    
    let totalUsage = parseFloat(document.getElementById('in_paint_total').value);
    if(isNaN(totalUsage) || totalUsage <= 0) { showStatus("âš ï¸ è«‹è¼¸å…¥ä½¿ç”¨é‡", "red"); return; }
    
    let usage = {}; COMPONENTS.forEach(c => usage[c] = 0); usage[currentBatchComponent] = totalUsage;
    let prod = {}, rework = {}, hasData = false;

    Object.keys(partRatios).forEach(p => {
        let vProd = parseInt(document.getElementById(`in_prod_${p}`).value) || 0;
        let vRework = parseInt(document.getElementById(`in_rework_${p}`).value) || 0;
        if(vProd > 0) prod[p] = vProd;
        if(vRework > 0) rework[p] = vRework;
        if(vProd > 0 || vRework > 0) hasData = true;
    });

    if(!hasData) { showStatus("âš ï¸ è«‹è¼¸å…¥è‡³å°‘ä¸€é …æ•¸æ“š", "red"); return; }

    todayTempList.push({ usage, prod, rework, componentName: currentBatchComponent });
    renderTodayList();
    clearTodayInput(false);
}

function updateModifiedRecord() {
    if (modifyingIndex < 0) return;
    let totalUsage = parseFloat(document.getElementById('in_paint_total').value);
    if(isNaN(totalUsage) || totalUsage <= 0) { showStatus("âš ï¸ è«‹è¼¸å…¥ä½¿ç”¨é‡", "red"); return; }
    
    let usage = {}; COMPONENTS.forEach(c => usage[c] = 0); usage[currentBatchComponent] = totalUsage;
    let prod = {}, rework = {}, hasData = false;
    
    Object.keys(partRatios).forEach(p => {
        let vProd = parseInt(document.getElementById(`in_prod_${p}`).value) || 0;
        let vRework = parseInt(document.getElementById(`in_rework_${p}`).value) || 0;
        if(vProd > 0) prod[p] = vProd;
        if(vRework > 0) rework[p] = vRework;
        if(vProd > 0 || vRework > 0) hasData = true;
    });
    
    if(!hasData) { showStatus("âš ï¸ è«‹è¼¸å…¥è‡³å°‘ä¸€é …æ•¸æ“š", "red"); return; }

    historicalData[modifyingIndex] = {
        date: document.getElementById('inputDate').value,
        paintUsage: usage, prod, rework, // Save separate rework
        componentName: currentBatchComponent
    };
    
    localStorage.setItem('V35_History', JSON.stringify(historicalData));
    modifyingIndex = -1;
    clearTodayInput(true);
    recalculateFormula();
    renderHistoryTable();
    showStatus("âœ… ä¿®æ”¹å®Œæˆ", "green");
}

function clearTodayInput(clearList = true) {
    document.getElementById('in_paint_total').value = '';
    document.querySelectorAll('#partInputList input').forEach(i => { i.value = ''; });
    document.querySelectorAll('.rework-rate').forEach(d => d.innerText = '0%');
    
    if(clearList) { todayTempList = []; renderTodayList(); }
    currentBatchComponent = '';
    modifyingIndex = -1;
    renderInputFields();
}

function renderTodayList() {
    const div = document.getElementById('todayListDisplay');
    if(todayTempList.length === 0) { div.innerText = 'ä»Šæ—¥å°šæœªåŠ å…¥æ•¸æ“š'; return; }
    
    div.innerHTML = todayTempList.map((item, idx) => {
        let total = item.usage[item.componentName].toFixed(2);
        // é¡¯ç¤ºç”Ÿç”¢èˆ‡é‡å·¥æ‘˜è¦
        let details = Object.keys(partRatios).map(p => {
            let pr = item.prod[p] || 0;
            let rw = item.rework[p] || 0;
            if(pr===0 && rw===0) return null;
            return `${p}:${pr}${rw>0 ? `(+${rw}é‡)` : ''}`;
        }).filter(x=>x).join(', ');
        
        return `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #ddd; font-size:13px;">
            <span class="comp-blue">${item.componentName} ${total}kg</span>
            <span>${details}</span>
        </div>`;
    }).join('');
}

function submitToHistory() {
    if(todayTempList.length === 0) { showStatus("ç„¡æ•¸æ“š", "red"); return; }
    const date = document.getElementById('inputDate').value;
    todayTempList.forEach(item => {
        historicalData.push({ 
            date: date, 
            paintUsage: item.usage, 
            partProd: item.prod, // ä¿ç•™èˆŠæ¬„ä½åç›¸å®¹
            partRework: item.rework, // æ–°å¢æ¬„ä½
            componentName: item.componentName 
        });
    });
    localStorage.setItem('V35_History', JSON.stringify(historicalData));
    todayTempList = [];
    renderTodayList();
    recalculateFormula();
    renderHistoryTable();
    showStatus("âœ… å·²å­˜å…¥æ­·å²ç´€éŒ„", "#007aff");
}

/* --- é…æ–¹è¨ˆç®— (åŠ å…¥é‡å·¥é‚è¼¯) --- */
function recalculateFormula() {
    let totals = {}; 
    COMPONENTS.forEach(c => totals[c] = { kg: 0, work: 0 });

    historicalData.forEach(rec => {
        let work = 0;
        // å·¥ä½œé‡ = (è‰¯å“ + é‡å·¥) * å€ç‡
        let reworkData = rec.partRework || {};
        
        for(let p in partRatios) {
            let prod = rec.partProd[p] || 0;
            let rew = reworkData[p] || 0;
            work += (prod + rew) * partRatios[p];
        }
        
        for(let c in rec.paintUsage) {
            if (rec.paintUsage[c] > 0) {
                totals[c].kg += rec.paintUsage[c];
                totals[c].work += work;
            }
        }
    });

    calculatedBaseFormula = {};
    COMPONENTS.forEach(c => {
        const t = totals[c];
        calculatedBaseFormula[c] = (t.work > 0) ? (t.kg / t.work) : 0;
    });
    
    queryRecipe();
}

/* --- æŸ¥è©¢èˆ‡æˆæœ¬ (é€²éšç‰ˆ) --- */
function renderQueryControls() {
    document.getElementById('paintOptions').innerHTML = paintList.map(p => `<option value="${p}">`).join('');
    document.getElementById('partBtnGroup').innerHTML = Object.keys(partRatios).map(p => `
        <button class="btn-part ${p===currentPart?'active':''}" onclick="selectPart('${p}')">${p}</button>
    `).join('');
}

function selectPart(p) {
    currentPart = p;
    document.querySelectorAll('#partBtnGroup .btn-part').forEach(b => b.classList.toggle('active', b.innerText === p));
    queryRecipe();
}

function queryRecipe() {
    const name = document.getElementById('paintSearchInput').value.trim();
    const tbody = document.getElementById('recipeResultBody');
    const tfoot = document.getElementById('recipeResultFoot');
    
    if(!name) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">è«‹è¼¸å…¥å‹è™Ÿ</td></tr>'; tfoot.style.display='none'; return; }

    let clean = name.replace(/[^a-zA-Z0-9]/g, '');
    let cat = clean.charAt(0).toUpperCase();
    let code = clean.slice(-1);
    
    const rule = ruleTable.find(r => r.cat === cat && r.code.toUpperCase() === code.toUpperCase());
    
    if(!rule) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">ç„¡æ­¤è£½ç¨‹è¦å‰‡ (${cat}-${code})</td></tr>`;
        tfoot.style.display='none';
        return;
    }

    tbody.innerHTML = '';
    const ratio = partRatios[currentPart] || 1.0;
    let totalCost = 0;
    let hasItem = false;

    COMPONENTS.forEach(comp => {
        if(rule.recipe[comp]) {
            hasItem = true;
            const kg = (calculatedBaseFormula[comp] || 0) * ratio; // ç”¨é‡è¨ˆç®—
            
            // æˆæœ¬é‚è¼¯: è‹¥æ˜¯é¢æ¼†ï¼ŒæŸ¥ç‰¹å®šè¡¨ï¼›å¦å‰‡æŸ¥åŸºç¤è¡¨
            let price = 0;
            if(comp === 'é¢æ¼†') {
                price = topcoatCosts[name] || baseCosts['é¢æ¼†'] || 300;
            } else {
                price = baseCosts[comp] || 300;
            }
            
            const cost = kg * price;
            totalCost += cost;
            
            // ITEM 1: å–®ä»¶ç”¨é‡æ”¹ç‚º toFixed(3)
            let dispName = comp === "é¢æ¼†" ? `<span class="comp-blue">${name}</span>` : comp;
            
            tbody.innerHTML += `<tr>
                <td>${dispName}</td>
                <td class="highlight-val">${kg.toFixed(3)}</td>
                <td class="cost-val">$${cost.toFixed(1)}</td>
            </tr>`;
        }
    });

    if(!hasItem) { tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">ç„¡æˆåˆ†</td></tr>`; }
    
    // ç¸½æˆæœ¬é¡¯ç¤º
    document.getElementById('totalCostDisplay').innerText = '$' + totalCost.toFixed(1);
    tfoot.style.display = 'table-footer-group';
}

/* --- ç®¡ç†ä¸­å¿ƒ --- */
function openManageModal() {
    document.getElementById('manageModal').style.display = 'block';
    modifyingIndex = -1;
    switchTab('tabInput');
    renderInputFields();
    renderCostTable();
    renderHistoryTable();
    renderPaintListTable();
    renderRuleTable();
    renderRatioTable();
}

function closeModal() { document.getElementById('manageModal').style.display = 'none'; }

function switchTab(id) {
    document.querySelectorAll('.modal-content > div[id^="tab"]').forEach(d => d.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    // ITEM 5: æ›´æ–° Tab æ¨™é¡Œé¡¯ç¤º
    let tabNameMap = {
        'tabCost': 'æˆæœ¬å–®åƒ¹',
        'tabHistory': 'æ­·å²ç´€éŒ„',
        'tabPaint': 'é¢æ¼†æ¸…å–®',
        'tabRule': 'è£½ç¨‹è¦å‰‡',
        'tabRatio': 'åŸºæº–å€ç‡',
        'tabInput': 'æ¯æ—¥è¼¸å…¥ (å«é‡å·¥)'
    };
    
    const btn = document.querySelector(`button[onclick="switchTab('${id}')"]`);
    if (btn) {
        btn.classList.add('active');
        // Manually update the text if needed, but here we just rely on the existing HTML text
    }
}

// æ­·å²æ˜ç´° (è—å­— + é‡å·¥é¡¯ç¤º)
function renderHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = historicalData.slice().reverse().map((rec, i) => {
        let realIdx = historicalData.length - 1 - i;
        
        // ITEM 3: æ‰€æœ‰æˆåˆ†çš†é¡¯ç¤ºè—è‰²å­—é«”
        let comps = Object.entries(rec.paintUsage).filter(x=>x[1]>0).map(([k,v]) => {
            // æ‰€æœ‰æˆåˆ†éƒ½å¥—ç”¨ comp-blue æ¨£å¼
            return `<span class="comp-blue">${k}</span> ${v.toFixed(1)}kg`;
        }).join(', ');
        
        // ç”¢é‡æ˜ç´°
        let parts = Object.keys(rec.partProd).map(p => {
            let pr = rec.partProd[p];
            let rw = (rec.partRework && rec.partRework[p]) ? rec.partRework[p] : 0;
            return rw > 0 ? `${p}:${pr}+${rw}é‡` : `${p}:${pr}`;
        }).join(', ');
        
        return `<tr>
            <td>${rec.date}</td>
            <td style="text-align:left;">
                <div>${comps}</div>
                <div style="font-size:12px; color:#666;">${parts}</div>
            </td>
            <td>
                <button onclick="modifyHistory(${realIdx})" style="color:#ff9500; border:none; background:none; cursor:pointer;">ä¿®æ”¹</button>
                <button onclick="deleteHistory(${realIdx})" style="color:red; border:none; background:none; cursor:pointer;">åˆªé™¤</button>
            </td>
        </tr>`;
    }).join('');
}

function modifyHistory(idx) {
    const rec = historicalData[idx];
    modifyingIndex = idx;
    switchTab('tabInput');
    
    document.getElementById('inputDate').value = rec.date;
    selectBatchComponent(rec.componentName);
    document.getElementById('in_paint_total').value = rec.paintUsage[rec.componentName];
    
    renderInputFields(); // é‡ç¹ªè¼¸å…¥æ¡†
    // å¡«å…¥æ•¸å€¼
    setTimeout(() => {
        Object.keys(partRatios).forEach(p => {
            if(rec.partProd[p]) document.getElementById(`in_prod_${p}`).value = rec.partProd[p];
            if(rec.partRework && rec.partRework[p]) document.getElementById(`in_rework_${p}`).value = rec.partRework[p];
            calcReworkRate(p);
        });
    }, 0);
    showStatus("âœï¸ ç·¨è¼¯æ¨¡å¼", "#ff9500");
}

function deleteHistory(idx) {
    if(confirm("åˆªé™¤æ­¤ç­†ï¼Ÿ")) {
        historicalData.splice(idx, 1);
        localStorage.setItem('V35_History', JSON.stringify(historicalData));
        renderHistoryTable();
        recalculateFormula();
    }
}

/* --- æˆæœ¬ç®¡ç† (åˆ†é›¢å¼) --- */
function renderCostTable() {
    // 1. é…æ–¹å–®åƒ¹
    document.getElementById('baseCostBody').innerHTML = COMPONENTS.map(c => {
        if(c === 'é¢æ¼†') return `<tr><td>é¢æ¼† (é è¨­)</td><td><input type="number" value="${baseCosts[c]}" onchange="baseCosts['${c}']=this.value" class="cost-input"></td></tr>`;
        return `<tr><td>${c}</td><td><input type="number" value="${baseCosts[c]}" onchange="baseCosts['${c}']=this.value" class="cost-input"></td></tr>`;
    }).join('');
    
    // 2. é¢æ¼†å–®åƒ¹
    renderTopcoatCostTable();
}

function renderTopcoatCostTable() {
    document.getElementById('topcoatCostBody').innerHTML = Object.keys(topcoatCosts).map(name => `
        <tr>
            <td class="comp-blue">${name}</td>
            <td>$${topcoatCosts[name]}</td>
            <td><button onclick="deleteTopcoatCost('${name}')" style="color:red; border:none; background:none;">âœ•</button></td>
        </tr>
    `).join('');
}

function addTopcoatPrice() {
    const name = document.getElementById('costPaintName').value.trim();
    const price = parseFloat(document.getElementById('costPaintPrice').value);
    if(name && price > 0) {
        if (topcoatCosts.hasOwnProperty(name)) {
            showStatus(`âš ï¸ é¢æ¼† ${name} å·²å­˜åœ¨ï¼Œå°‡æ›´æ–°å–®åƒ¹ã€‚`, "#ff9500");
        }
        topcoatCosts[name] = price;
        document.getElementById('costPaintName').value = '';
        document.getElementById('costPaintPrice').value = '';
        renderTopcoatCostTable();
    } else {
        showStatus("âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆå‹è™Ÿèˆ‡å–®åƒ¹", "red");
    }
}

function deleteTopcoatCost(name) {
    if(confirm(`ç¢ºå®šåˆªé™¤é¢æ¼† ${name} çš„å€‹åˆ¥å®šåƒ¹å—ï¼Ÿ`)) {
        delete topcoatCosts[name];
        renderTopcoatCostTable();
    }
}

/* --- å…¶ä»–åŸºç¤è¡¨æ ¼ (ç¶­æŒä¸è®Š) --- */
function renderPaintListTable() {
    document.getElementById('paintListBody').innerHTML = paintList.map((p, i) => `
        <tr><td>${p}</td><td><button onclick="paintList.splice(${i},1);renderPaintListTable();renderQueryControls()" style="color:red;border:none;background:none;">âœ•</button></td></tr>
    `).join('');
}

// ITEM 6: æ–°å¢é‡è¤‡æª¢æŸ¥æç¤º
function addPaint() { 
    let v=document.getElementById('newPaintName').value.trim(); 
    if(!v) return;

    if(paintList.includes(v)) {
        showStatus(`âš ï¸ å‹è™Ÿ ${v} å·²å­˜åœ¨æ–¼æ¸…å–®ä¸­`, "red");
        return;
    }
    
    paintList.push(v); 
    paintList.sort(); 
    renderPaintListTable(); 
    renderQueryControls(); 
    document.getElementById('newPaintName').value=''; 
    showStatus(`âœ… å‹è™Ÿ ${v} å·²æ–°å¢`, "#007aff");
}

function renderRuleTable() {
    const t = document.getElementById('ruleTable');
    let h = `<thead><tr><th>é¡</th><th>ç¢¼</th>${COMPONENTS.map(c=>`<th style="font-size:10px">${c}</th>`).join('')}</tr></thead><tbody>`;
    let lastCat = '';
    ruleTable.forEach((r, i) => {
        let cell = r.cat!==lastCat ? `<td rowspan="${ruleTable.filter(x=>x.cat===r.cat).length}" style="font-weight:bold;background:#fff;border-right:1px solid #ddd;">${r.cat}</td>` : '';
        if(r.cat!==lastCat) lastCat=r.cat;
        let cks = COMPONENTS.map(c => `<td><input type="checkbox" ${r.recipe[c]?'checked':''} onchange="ruleTable[${i}].recipe['${c}']=this.checked"></td>`).join('');
        h += `<tr>${cell}<td>${r.code}</td>${cks}</tr>`;
    });
    t.innerHTML = h+'</tbody>';
}

function renderRatioTable() {
    document.getElementById('ratioTableBody').innerHTML = Object.keys(partRatios).map(p => `
        <tr><td>${p}</td><td><input type="number" value="${partRatios[p]}" onchange="partRatios['${p}']=this.value" style="width:60px;"></td></tr>
    `).join('');
}

function saveAllSettings() {
    localStorage.setItem('V35_PaintList', JSON.stringify(paintList));
    localStorage.setItem('V35_Rules', JSON.stringify(ruleTable));
    localStorage.setItem('V35_Ratios', JSON.stringify(partRatios));
    localStorage.setItem('V35_BaseCosts', JSON.stringify(baseCosts));
    localStorage.setItem('V35_TopcoatCosts', JSON.stringify(topcoatCosts));
    renderQueryControls(); recalculateFormula(); alert("è¨­å®šå·²å„²å­˜"); closeModal();
}

function showStatus(m, c) { const e=document.getElementById('statusMessage'); e.innerText=m; e.style.color=c; setTimeout(()=>e.innerText='',3000); }

init();
</script>
</body>
</html>
