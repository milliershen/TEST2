<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…æ–¹æŸ¥è©¢ (V37.0 - å‚™ä»½é‚„åŸç‰ˆ)</title>
    <style>
        /* --- Apple é¢¨æ ¼åŸºç¤è¨­å®š --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", sans-serif; 
            background-color: #f2f2f7; padding: 15px; color: #1c1c1e; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08); 
        }
        h2 { color: #1c1c1e; margin-bottom: 25px; font-weight: 700; font-size: 26px; text-align: center; }
        
        /* å€å¡Šé€šç”¨ */
        .section-card { margin-bottom: 30px; border: 1px solid #e5e5ea; border-radius: 12px; padding: 20px; background: #fff; }
        
        /* æœå°‹æ§åˆ¶åˆ— */
        .query-controls-bar {
            display: flex; gap: 15px; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; 
        }
        .search-input { 
            flex-grow: 1; padding: 12px; font-size: 16px; border-radius: 10px; border: 1px solid #d1d1d6; 
        }

        /* æŒ‰éˆ•æ’ç‰ˆ */
        .part-buttons { flex-grow: 1; display: flex; gap: 5px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        
        #paintInputButtons { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px;}
        .btn-part { 
            padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 15px; 
            cursor: pointer; white-space: nowrap; text-align: center; min-width: 70px; flex: 1;
        }
        .btn-part.active { background: #007aff; color: white; border-color: #007aff; }

        /* çµæœè¡¨æ ¼ */
        .result-table { width: 100%; border-collapse: collapse; }
        .result-table th { text-align: left; padding: 10px; background: #f2f2f7; font-size: 13px; color: #555; }
        .result-table td { padding: 10px; border-bottom: 1px solid #eee; font-size: 15px; }
        .highlight-val { color: #007aff; font-weight: 700; }
        .cost-val { color: #ff3b30; font-weight: 600; font-size: 14px; }
        .total-row td { border-top: 2px solid #007aff; font-weight: bold; background-color: #f9f9fd; color: #1c1c1e; }

        /* ç®¡ç†æŒ‰éˆ• */
        .btn-manage { 
            background-color: #34c759; color: white; padding: 12px 25px; border: none; border-radius: 10px; 
            font-size: 15px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 20px;
        }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: white; margin: 2% auto; padding: 20px; border-radius: 16px; width: 95%; max-width: 950px; max-height: 90vh; overflow-y: auto; }
        
        .tab-group { display: flex; gap: 5px; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; overflow-x: auto; }
        .tab-btn { padding: 8px 15px; background: #f2f2f7; border: none; border-radius: 8px; cursor: pointer; color: #888; font-weight: 600; white-space: nowrap; }
        .tab-btn.active { background: #007aff; color: white; }
        
        /* è¼¸å…¥é …ç›® (æ”¯æ´é‡å·¥æ¬„ä½) */
        .input-row-complex { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 8px 0; border-bottom: 1px dashed #e5e5ea; 
        }
        .input-label { width: 80px; font-weight: 600; font-size: 14px; }
        .input-group-sub { display: flex; gap: 5px; align-items: center; }
        .input-sub-field { width: 70px; padding: 5px; border: 1px solid #d1d1d6; border-radius: 6px; text-align: right; }
        .sub-label { font-size: 12px; color: #888; margin-right: 2px; }
        .rework-rate { font-size: 12px; color: #ff3b30; width: 50px; text-align: right; }

        /* æŒ‰éˆ•çµ„ */
        .btn-group { display: flex; gap: 10px; margin-top: 15px; max-width: 600px; margin-left: auto; margin-right: auto; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 15px; font-weight: 600; cursor: pointer; color: white; }
        .btn-add { background-color: #34c759; } 
        .btn-submit { background-color: #007aff; }
        .btn-modify-save { background-color: #ffc200; color: #1c1c1e;} 
        .btn-clear-daily { background-color: #ff3b30; }

        /* ç®¡ç†è¡¨æ ¼ */
        .manage-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .manage-table th { background: #f2f2f7; padding: 8px; text-align: left; }
        .manage-table td { padding: 8px; border-bottom: 1px solid #eee; }
        
        .comp-blue { color: #007aff; font-weight: 700; }
        
        .cost-input-group { display: flex; gap: 5px; align-items: center; }
        .cost-input { width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        
        /* è£½ç¨‹è¦å‰‡å°ˆç”¨æ’ç‰ˆ */
        .rule-group-card { 
            border: 1px solid #e5e5ea; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #f9f9fb;
        }
        .rule-header { font-weight: 700; font-size: 16px; margin-bottom: 10px; color: #007aff; border-bottom: 2px solid #007aff; padding-bottom: 5px;}
        .rule-item-row { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 8px; }
        .rule-item { 
            display: flex; flex-direction: column; align-items: center; border: 1px solid #ddd; border-radius: 8px; padding: 5px;
            width: 80px; min-width: 80px; text-align: center; background: white;
        }
        .rule-item-code { font-weight: 600; font-size: 14px; color: #1c1c1e; }
        .rule-item-comp-input { width: 70px; padding: 3px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-size: 12px; }
        .rule-item-comp-label { font-size: 10px; color: #888; margin-top: 3px; }

        /* ç¼ºå¤±è¦å‰‡æç¤ºå€ */
        .missing-rule-alert {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff2f2;
            border: 1px solid #ffcccc;
            border-radius: 8px;
            color: #d32f2f;
        }
        .missing-list {
            font-size: 13px;
            margin-top: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .missing-tag {
            background: #ffebee;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #ffcdd2;
        }

        /* ç‹€æ…‹å›é¥‹ */
        #statusMessage {
            text-align: center; 
            margin-top: 10px; 
            height: 20px; 
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>é…æ–¹æŸ¥è©¢ <span style="font-size:14px; color:#888;">(V37.0 - å‚™ä»½é‚„åŸç‰ˆ)</span></h2>

    <div class="section-card">
        <div class="query-controls-bar">
            <span style="font-weight:700; color:#007aff; white-space:nowrap;">é¢æ¼†æŸ¥è©¢</span>
            <input list="paintOptions" id="paintSearchInput" class="search-input" placeholder="è¼¸å…¥æˆ–é¸æ“‡é¢æ¼†å‹è™Ÿ (ä¾‹å¦‚ A8...)" oninput="queryRecipe()">
            <datalist id="paintOptions"></datalist>
        </div>

        <div class="part-buttons" id="partBtnGroup" style="margin-bottom: 20px;"></div>

        <table class="result-table">
            <thead>
                <tr>
                    <th width="35%">é…æ–¹æˆåˆ†</th>
                    <th width="30%">å–®ä»¶ç”¨é‡ (KG)</th>
                    <th width="35%">é ä¼°æˆæœ¬ (NTD)</th>
                </tr>
            </thead>
            <tbody id="recipeResultBody">
                <tr><td colspan="3" style="text-align:center; color:#999; padding:20px;">è«‹è¼¸å…¥å‹è™Ÿä¸¦é¸æ“‡éƒ¨ä»¶</td></tr>
            </tbody>
            <tfoot id="recipeResultFoot" style="display:none;">
                <tr class="total-row">
                    <td>ç¸½è¨ˆæˆæœ¬</td>
                    <td></td>
                    <td id="totalCostDisplay">$0.0</td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <button class="btn-manage" onclick="openManageModal()">âš™ï¸ æ•¸æ“šç®¡ç†ä¸­å¿ƒ</button>
</div>

<!-- Modal -->
<div id="manageModal" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
            <span style="font-size:18px; font-weight:bold;">æ•¸æ“šç®¡ç†ä¸­å¿ƒ</span>
            <span onclick="closeModal()" style="cursor:pointer; font-size:20px;">âœ•</span>
        </div>
        
        <div class="tab-group">
            <button class="tab-btn active" onclick="switchTab('tabInput')">æ¯æ—¥è¼¸å…¥</button>
            <button class="tab-btn" onclick="switchTab('tabHistory')">æ­·å²ç´€éŒ„</button>
            <button class="tab-btn" onclick="switchTab('tabCost')">æˆæœ¬å–®åƒ¹</button>
            <button class="tab-btn" onclick="switchTab('tabPaint')">é¢æ¼†æ¸…å–®</button>
            <button class="tab-btn" onclick="switchTab('tabRule')">è£½ç¨‹è¦å‰‡</button>
            <button class="tab-btn" onclick="switchTab('tabRatio')">åŸºæº–å€ç‡</button>
            <!-- 3. æ–°å¢å‚™è¨»æ¬„ -->
            <button class="tab-btn" onclick="switchTab('tabNote')">å‚™è¨»</button>
            <!-- 4. æ–°å¢å‚™ä»½åŠŸèƒ½ -->
            <button class="tab-btn" onclick="switchTab('tabBackup')" style="color:#e67e22;">ç³»çµ±å‚™ä»½</button>
        </div>

        <!-- æ¯æ—¥è¼¸å…¥ Tab -->
        <div id="tabInput" style="display:block;">
            <div style="text-align:center; margin-bottom:15px; background:#f9f9f9; padding:8px; border-radius:8px;">
                <label>æ—¥æœŸ: </label>
                <input type="date" id="inputDate" style="padding:5px; border:1px solid #ccc; border-radius:4px;">
            </div>

            <div id="paintInputButtons"></div>
            
            <div style="text-align:center; margin-bottom:20px;">
                <label style="font-weight:bold;">ç¸½ä½¿ç”¨é‡ (KG): </label>
                <input type="number" id="in_paint_total" placeholder="0" step="0.01" style="width:100px; padding:6px; border:1px solid #ccc; border-radius:4px;">
            </div>

            <div style="max-width: 600px; margin: 0 auto; border: 1px solid #e5e5ea; border-radius: 8px; padding: 15px;">
                <h4 style="margin:0 0 10px 0; color:#555;">æ¬¡æ•¸è¼¸å…¥</h4> 
                <div id="partInputList"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-add" id="btnAddRecord" onclick="addTodayRecord()">â¬‡ï¸ åŠ å…¥ä»Šæ—¥æ¸…å–®</button>
                <button class="btn btn-modify-save" id="btnUpdateRecord" style="display:none;" onclick="updateModifiedRecord()">ğŸ”„ æ›´æ–°æ­¤ç´€éŒ„</button>
                <button class="btn btn-clear-daily" onclick="clearTodayInput()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>

            <div id="todayListDisplay" style="margin-top:15px; background:#f2f2f7; padding:10px; border-radius:8px; min-height:40px; text-align:center; color:#888;">ä»Šæ—¥å°šæœªåŠ å…¥æ•¸æ“š</div>

            <div style="text-align:center; margin-top:20px;">
                <button class="btn btn-submit" style="max-width:300px;" onclick="submitToHistory()">ğŸ”„ ç¢ºèªæ›´æ–°ä¸¦è¨ˆç®—</button>
            </div>
        </div>

        <!-- æ­·å²ç´€éŒ„ Tab -->
        <div id="tabHistory" style="display:none;">
            <div style="max-height:60vh; overflow-y:auto;">
                <table class="manage-table">
                    <thead><tr><th>æ—¥æœŸ</th><th>æ˜ç´°è¡¨</th><th width="100">æ“ä½œ</th></tr></thead>
                    <tbody id="historyTableBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- æˆæœ¬è¨­å®š Tab -->
        <div id="tabCost" style="display:none;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h4>é…æ–¹å–®åƒ¹</h4>
                    <table class="manage-table">
                        <thead><tr><th>æˆåˆ†</th><th>å–®åƒ¹ ($/kg)</th></tr></thead>
                        <tbody id="baseCostBody"></tbody>
                    </table>
                </div>
                <div>
                    <h4>é¢æ¼†å–®åƒ¹</h4>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <input list="paintOptions" id="costPaintName" placeholder="é¸æ“‡æˆ–è¼¸å…¥é¢æ¼†å‹è™Ÿ" style="flex:1; padding:5px; border:1px solid #ddd;">
                        <input type="number" id="costPaintPrice" placeholder="å–®åƒ¹" style="width:70px; padding:5px; border:1px solid #ddd;">
                        <button onclick="addTopcoatPrice()" style="background:#34c759; color:white; border:none; padding:5px 10px; border-radius:4px;">æ–°å¢</button>
                    </div>
                    <div style="max-height:40vh; overflow-y:auto; border:1px solid #eee; border-radius:4px;">
                        <table class="manage-table">
                            <thead><tr><th>é¢æ¼†å‹è™Ÿ</th><th>å–®åƒ¹</th><th>åˆªé™¤</th></tr></thead>
                            <tbody id="topcoatCostBody"></tbody>
                        </table>
                    </div>
                    <p style="font-size:12px; color:#666;">* è‹¥æœªè¨­å®šå€‹åˆ¥åƒ¹æ ¼ï¼Œå°‡ä½¿ç”¨å·¦å´ã€Œé¢æ¼†ã€çš„é è¨­å–®åƒ¹ã€‚</p>
                </div>
            </div>
        </div>

        <!-- é¢æ¼†æ¸…å–® Tab -->
        <div id="tabPaint" style="display:none;">
            <div style="margin-bottom:10px; display:flex; gap:10px;">
                <input type="text" id="newPaintName" placeholder="æ–°å¢å‹è™Ÿ..." style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;">
                <button onclick="addPaint()" style="padding:8px 15px; background:#34c759; color:white; border:none; border-radius:5px;">+</button>
            </div>
            <div style="max-height:50vh; overflow-y:auto;">
                <table class="manage-table"><tbody id="paintListBody"></tbody></table>
            </div>
        </div>

        <!-- è£½ç¨‹è¦å‰‡ Tab -->
        <div id="tabRule" style="display:none;">
            <div id="ruleDisplayArea" style="max-height:50vh; overflow-y:auto;">
                <!-- è¦å‰‡å°‡åœ¨é€™è£¡åˆ†çµ„é¡¯ç¤º -->
            </div>
            <!-- 2. å¦‚æœæœ‰é¢æ¼† æ²’æœ‰å†è£½ç¨‹è¦å‰‡è£¡ è«‹åˆ—å‡ºä¾†çµ¦æˆ‘ -->
            <div id="missingRuleArea" class="missing-rule-alert" style="display:none;">
                <strong>âš ï¸ æ³¨æ„ï¼šä»¥ä¸‹é¢æ¼†å‹è™Ÿå°šæœªè¨­å®šè£½ç¨‹è¦å‰‡ï¼š</strong>
                <div id="missingRuleList" class="missing-list"></div>
            </div>
        </div>

        <!-- åŸºæº–å€ç‡ Tab -->
        <div id="tabRatio" style="display:none;">
            <table class="manage-table" id="ratioTable">
                <tbody id="ratioTableBody"></tbody>
            </table>
        </div>

        <!-- 3. æ–°å¢ å‚™è¨»æ¬„ -->
        <div id="tabNote" style="display:none;">
            <h4 style="margin-bottom:10px; color:#555;">å‚™è¨» / ç­†è¨˜</h4>
            <textarea id="userNotes" style="width:100%; height:300px; padding:10px; border:1px solid #ddd; border-radius:8px; font-size:14px; line-height:1.5;" placeholder="åœ¨æ­¤è¼¸å…¥ä»»ä½•å‚™è¨»äº‹é …..."></textarea>
        </div>

        <!-- 4. ç³»çµ±å‚™ä»½ Tab -->
        <div id="tabBackup" style="display:none;">
            <div style="padding:20px; text-align:center;">
                <h3 style="color:#007aff;">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
                <p style="color:#666; font-size:14px; margin-bottom:30px;">
                    å®šæœŸå‚™ä»½å¯ä»¥é˜²æ­¢è³‡æ–™éºå¤±ã€‚å‚™ä»½æª”æ¡ˆ (.json) å¯ä»¥å„²å­˜åœ¨æ‚¨çš„é›»è…¦ä¸­ã€‚
                </p>
                
                <div style="margin-bottom:30px; padding:20px; border:1px solid #eee; border-radius:12px;">
                    <h4 style="margin-top:0;">ğŸ“¤ åŒ¯å‡ºè³‡æ–™</h4>
                    <p style="font-size:12px; color:#888;">å°‡ç›®å‰æ‰€æœ‰è¨­å®šèˆ‡æ­·å²ç´€éŒ„ä¸‹è¼‰åˆ°é›»è…¦ã€‚</p>
                    <button class="btn btn-submit" style="width:200px;" onclick="exportData()">ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ</button>
                </div>

                <div style="padding:20px; border:1px dashed #ccc; border-radius:12px; background-color:#fafafa;">
                    <h4 style="margin-top:0;">ğŸ“¥ åŒ¯å…¥è³‡æ–™</h4>
                    <p style="font-size:12px; color:#888;">é¸æ“‡å‚™ä»½æª”æ¡ˆä»¥é‚„åŸè³‡æ–™ (å°‡è¦†è“‹ç¾æœ‰è³‡æ–™)ã€‚</p>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom:15px;">
                    <br>
                    <button class="btn btn-manage" style="width:200px; background-color:#ff9500;" onclick="importData()">è®€å–ä¸¦é‚„åŸ</button>
                </div>
            </div>
        </div>

        <div style="text-align:center; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-submit" style="width:200px;" onclick="saveAllSettings()">å„²å­˜æ‰€æœ‰è¨­å®š</button>
            <div id="saveStatus" style="margin-top:10px; font-weight:600; color:#1c1c1e; height:20px;"></div>
        </div>
    </div>
</div>

<script>
// --- V37.0 è³‡æ–™çµæ§‹ ---
const COMPONENTS = ["ç™½è‰²", "ç°è‰²", "é»‘è‰²", "TAP", "æ±é‚¦0.1", "æ±é‚¦0.2", "é‡‘æ²¹", "é¢æ¼†"];
const DEFAULT_PARTS = {"è»Šæ¶":1.0, "å‰å‰":0.5, "å¾Œä¸Šä¸‹å‰":0.5, "å‰ä¸‰è§’é›»":1.3, "å‰ä¸‰è§’":0.8, "å¾Œä¸‰è§’":0.5, "è»Šåœˆ":0.5, "è“‹è²¨æ¶":0.3, "é…ä»¶":0.3};

// V33 é¢æ¼†æ¸…å–® (ç¸®æ¸›ç‰ˆç¤ºæ„)
const DEFAULT_PAINTS = [
    "A153F","A119F","A225T","A242t","A266W","A268W","A291F","A304Z","A310F","A312F","A335Z","A482F","A515W","A618W","A638W","A641Z","A690T","A756Z","A852Z","A875t","A876Z","A878F","A883F","A930F","A993F","A996F","A804t","A801F","A990W",
    "B06F","B05Z","B07F","B04t-0.2","B100F","B127Z","B127Zä¸­","B133I","B133Iä¸­åº•","B249F","B273Iä¸­åº•","B328F","B454Z","B467Z","B536I","B579Z","B663t","B642Wä¸­","B731Z","B751Z","B753Z","B772W","B884I","B894R","B918F","B919F","B923t","B978R","B982F","B933F",
    "C207Z","C512N0.1","C583R","C732W","C786I ä¸­åº•","C786I é¢æ¼†","C211W","C844t","C882t","C895t","C995Z ä¸­åº•","C995Z",
    "G199t","G03t","G209I","G82t","G215Z","G215B","G03F","G232W","G244t","G246F","G303F","G311Z","G313B","G248F","G314Z","G315Z","G320Z","G321I","G323Z","G329W","G455Z","G463t","G486I","G498B","G580F","G590Z","G600F","G609t","G706R","G706Rä¸­","G710W","G770I","G771W","G885F","G866F","G915F","G916Xä¸­","G916Xé¢",
    "K704t","K01C","K144P","K376t","8900C","O333F","O189F","O402F","O480I","O485F","O546Z","O932F",
    "R89I","R191F","R243W","R326W","R253F","R270I","R298W","R293F","R322W","R447I","R459Z","R470I","R461I","R532I","R532Iä¸­","R611Bä¸­","R611B","R635Xä¸­","R635X","R470Iä¸­","R880I","R886Z","R887Iä¸­","R887I","R934F","R981F",
    "S443Z","S352T","S437W","S612Z","S746S","TC-21036","TC-24045","TC-24028","V238B","V200I","V324I","V458Z","V627R","V713W",
    "W210Iä¸­åº•","W210I","W14F","W214I","W300C","W327F","W348I","W650t","W700I","W806Iä¸­","W806I","W780F",
    "Y316I","Y247F","Y319Z","Y535F","Y774F", "A846F","B169t","B847","B849","B860t","B867t","G856","O588F","S859Z","V845F","W853Z"
];
// 1. è£½ç¨‹è¦å‰‡æ²’æœ‰8é€™å€‹é¡åˆ¥ å–æ¶ˆ
const RULE_CATS = ["A", "B", "C", "G", "K", "O", "R", "S", "V", "W", "Y"];
const RULE_CODES = ["F", "T", "t", "W", "Z", "I", "B", "R", "C", "S", "X", "P"];

// ç‹€æ…‹è®Šæ•¸
let partRatios = {};
let paintList = [];
let ruleTable = []; 
let historicalData = []; 
let baseCosts = {}; 
let topcoatCosts = {}; 
let calculatedBaseFormula = {};
let todayTempList = [];
let currentPart = "è»Šæ¶"; 
let currentBatchComponent = ''; 
let modifyingIndex = -1; 

function init() {
    // è¼‰å…¥ localStorage
    partRatios = JSON.parse(localStorage.getItem('V35_Ratios')) || DEFAULT_PARTS;
    let savedPaints = JSON.parse(localStorage.getItem('V35_PaintList'));
    paintList = (savedPaints && savedPaints.length > 50) ? savedPaints : DEFAULT_PAINTS.slice().sort();
    
    // æ­·å²è³‡æ–™
    historicalData = JSON.parse(localStorage.getItem('V35_History')) || [];

    // è¦å‰‡çµæ§‹
    ruleTable = JSON.parse(localStorage.getItem('V35_Rules')) || generateDefaultRules();
    
    // æˆæœ¬è¼‰å…¥
    baseCosts = JSON.parse(localStorage.getItem('V35_BaseCosts')) || {};
    COMPONENTS.forEach(c => { if(baseCosts[c] === undefined) baseCosts[c] = 300; });
    topcoatCosts = JSON.parse(localStorage.getItem('V35_TopcoatCosts')) || {};

    // è¼‰å…¥å‚™è¨»
    const savedNotes = localStorage.getItem('V35_Notes');
    if (savedNotes) {
        document.getElementById('userNotes').value = savedNotes;
    }

    document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
    recalculateFormula(); 
    renderQueryControls();
    
    document.addEventListener('keydown', e => { if(e.key === 'Escape') closeModal(); });
}

function generateDefaultRules() {
    let rules = [];
    RULE_CATS.forEach(cat => {
        RULE_CODES.forEach(code => {
            let recipe = {};
            COMPONENTS.forEach(c => recipe[c] = 0); 
            if(cat === 'A' && ['F','T'].includes(code)) {
                recipe['ç°è‰²'] = 1; 
                recipe['TAP'] = 1;
                recipe['é¢æ¼†'] = 1;
            }
            rules.push({ cat, code, recipe });
        });
    });
    return rules;
}

/* --- æ¯æ—¥è¼¸å…¥ --- */
function renderInputFields() {
    document.getElementById('paintInputButtons').innerHTML = COMPONENTS.map(c => `
        <button class="btn-part ${c===currentBatchComponent?'active':''}" onclick="selectBatchComponent('${c}')">${c}</button>
    `).join('');

    const partDiv = document.getElementById('partInputList');
    if(!partDiv.innerHTML || partDiv.children.length !== Object.keys(partRatios).length) {
        partDiv.innerHTML = Object.keys(partRatios).map(p => `
            <div class="input-row-complex">
                <div class="input-label">${p}</div>
                <div class="input-group-sub">
                    <span class="sub-label">æ¬¡æ•¸</span>
                    <input type="number" id="in_prod_${p}" class="input-sub-field" placeholder="0" oninput="calcReworkRate('${p}')">
                </div>
                <div class="input-group-sub">
                    <span class="sub-label">é‡å·¥</span>
                    <input type="number" id="in_rework_${p}" class="input-sub-field" placeholder="0" oninput="calcReworkRate('${p}')">
                </div>
                <div class="rework-rate" id="rate_${p}">0%</div>
            </div>
        `).join('');
    }
    
    const isEdit = modifyingIndex >= 0;
    document.getElementById('btnAddRecord').style.display = isEdit ? 'none' : 'block';
    document.getElementById('btnUpdateRecord').style.display = isEdit ? 'block' : 'none';
}

function selectBatchComponent(c) {
    currentBatchComponent = c;
    document.querySelectorAll('#paintInputButtons .btn-part').forEach(b => {
        b.classList.toggle('active', b.innerText === c);
    });
}

function calcReworkRate(part) {
    const prod = parseFloat(document.getElementById(`in_prod_${part}`).value) || 0;
    const rework = parseFloat(document.getElementById(`in_rework_${part}`).value) || 0;
    const rateDiv = document.getElementById(`rate_${part}`);
    
    if (prod > 0) {
        const rate = (rework / prod) * 100;
        rateDiv.innerText = rate.toFixed(1) + '%';
        rateDiv.style.color = rate > 10 ? 'red' : (rate > 0 ? '#ff9500' : '#ccc');
    } else {
        rateDiv.innerText = rework > 0 ? '100%' : '0%';
    }
}

function addTodayRecord() {
    if (modifyingIndex >= 0) { alert("è«‹å…ˆé€€å‡ºä¿®æ”¹æ¨¡å¼"); return; }
    if (!currentBatchComponent) { alert("è«‹é¸æ“‡æˆåˆ†"); return; }
    
    let totalUsage = parseFloat(document.getElementById('in_paint_total').value);
    if(isNaN(totalUsage) || totalUsage <= 0) { alert("è«‹è¼¸å…¥ä½¿ç”¨é‡"); return; }
    
    let usage = {}; COMPONENTS.forEach(c => usage[c] = 0); usage[currentBatchComponent] = totalUsage;
    let prod = {}, rework = {}, hasData = false;

    Object.keys(partRatios).forEach(p => {
        let vProd = parseInt(document.getElementById(`in_prod_${p}`).value) || 0;
        let vRework = parseInt(document.getElementById(`in_rework_${p}`).value) || 0;
        if(vProd > 0) prod[p] = vProd;
        if(vRework > 0) rework[p] = vRework;
        if(vProd > 0 || vRework > 0) hasData = true;
    });

    if(!hasData) { alert("è«‹è¼¸å…¥è‡³å°‘ä¸€é …æ•¸æ“š"); return; }

    todayTempList.push({ usage, prod, rework, componentName: currentBatchComponent });
    renderTodayList();
    clearTodayInput(false);
}

function updateModifiedRecord() {
    if (modifyingIndex < 0) return;
    let totalUsage = parseFloat(document.getElementById('in_paint_total').value);
    if(isNaN(totalUsage) || totalUsage <= 0) { alert("è«‹è¼¸å…¥ä½¿ç”¨é‡"); return; }
    
    let usage = {}; COMPONENTS.forEach(c => usage[c] = 0); usage[currentBatchComponent] = totalUsage;
    let prod = {}, rework = {}, hasData = false;
    
    Object.keys(partRatios).forEach(p => {
        let vProd = parseInt(document.getElementById(`in_prod_${p}`).value) || 0;
        let vRework = parseInt(document.getElementById(`in_rework_${p}`).value) || 0;
        if(vProd > 0) prod[p] = vProd;
        if(vRework > 0) rework[p] = vRework;
        if(vProd > 0 || vRework > 0) hasData = true;
    });
    
    if(!hasData) { alert("è«‹è¼¸å…¥è‡³å°‘ä¸€é …æ•¸æ“š"); return; }

    historicalData[modifyingIndex] = {
        date: document.getElementById('inputDate').value,
        paintUsage: usage, prod, rework, 
        componentName: currentBatchComponent
    };
    
    localStorage.setItem('V35_History', JSON.stringify(historicalData));
    modifyingIndex = -1;
    clearTodayInput(true);
    recalculateFormula();
    renderHistoryTable();
    showStatus("âœ… ä¿®æ”¹å®Œæˆ", "green");
}

function clearTodayInput(clearList = true) {
    document.getElementById('in_paint_total').value = '';
    document.querySelectorAll('#partInputList input').forEach(i => { i.value = ''; });
    document.querySelectorAll('.rework-rate').forEach(d => d.innerText = '0%');
    
    if(clearList) { todayTempList = []; renderTodayList(); }
    currentBatchComponent = '';
    modifyingIndex = -1;
    renderInputFields();
}

function renderTodayList() {
    const div = document.getElementById('todayListDisplay');
    if(todayTempList.length === 0) { div.innerText = 'ä»Šæ—¥å°šæœªåŠ å…¥æ•¸æ“š'; return; }
    
    div.innerHTML = todayTempList.map((item, idx) => {
        let total = item.usage[item.componentName].toFixed(2);
        let details = Object.keys(partRatios).map(p => {
            let pr = item.prod[p] || 0;
            let rw = item.rework[p] || 0;
            if(pr===0 && rw===0) return null;
            return `${p}:${pr}${rw>0 ? `(+${rw}é‡)` : ''}`;
        }).filter(x=>x).join(', ');
        
        return `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #ddd; font-size:13px;">
            <span class="comp-blue">${item.componentName} ${total}kg</span>
            <span>${details}</span>
        </div>`;
    }).join('');
}

function submitToHistory() {
    if(todayTempList.length === 0) { alert("ç„¡æ•¸æ“š"); return; }
    const date = document.getElementById('inputDate').value;
    todayTempList.forEach(item => {
        historicalData.push({ 
            date: date, 
            paintUsage: item.usage, 
            partProd: item.prod, 
            partRework: item.rework, 
            componentName: item.componentName 
        });
    });
    localStorage.setItem('V35_History', JSON.stringify(historicalData));
    todayTempList = [];
    renderTodayList();
    recalculateFormula();
    renderHistoryTable();
    showStatus("âœ… å·²å­˜å…¥æ­·å²ç´€éŒ„", "#007aff");
}

/* --- é…æ–¹è¨ˆç®— --- */
function recalculateFormula() {
    let totals = {}; 
    COMPONENTS.forEach(c => totals[c] = { kg: 0, work: 0 });

    historicalData.forEach(rec => {
        let work = 0;
        let reworkData = rec.partRework || {};
        
        for(let p in partRatios) {
            let prod = rec.partProd[p] || 0;
            let rew = reworkData[p] || 0;
            work += (prod + rew) * partRatios[p];
        }
        
        for(let c in rec.paintUsage) {
            if (rec.paintUsage[c] > 0) {
                totals[c].kg += rec.paintUsage[c];
                totals[c].work += work;
            }
        }
    });

    calculatedBaseFormula = {};
    COMPONENTS.forEach(c => {
        const t = totals[c];
        calculatedBaseFormula[c] = (t.work > 0) ? (t.kg / t.work) : 0;
    });
    
    queryRecipe();
}

/* --- æŸ¥è©¢èˆ‡æˆæœ¬ --- */
function renderQueryControls() {
    document.getElementById('paintOptions').innerHTML = paintList.map(p => `<option value="${p}">`).join('');
    document.getElementById('partBtnGroup').innerHTML = Object.keys(partRatios).map(p => `
        <button class="btn-part ${p===currentPart?'active':''}" onclick="selectPart('${p}')">${p}</button>
    `).join('');
}

function selectPart(p) {
    currentPart = p;
    document.querySelectorAll('#partBtnGroup .btn-part').forEach(b => b.classList.toggle('active', b.innerText === p));
    queryRecipe();
}

function queryRecipe() {
    const name = document.getElementById('paintSearchInput').value.trim();
    const tbody = document.getElementById('recipeResultBody');
    const tfoot = document.getElementById('recipeResultFoot');
    
    if(!name) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">è«‹è¼¸å…¥å‹è™Ÿ</td></tr>'; tfoot.style.display='none'; return; }

    let clean = name.replace(/[^a-zA-Z0-9]/g, '');
    if (clean.length < 2) return; 

    let cat = clean.charAt(0).toUpperCase();
    let code = clean.slice(-1);
    
    // ç‰¹æ®Šè™•ç†ï¼šè‹¥ä»£ç¢¼æ˜¯æ•¸å­—ï¼Œå¯èƒ½ä¸æ˜¯è¦å‰‡ä»£ç¢¼ï¼Œé€™è£¡ç°¡å–®å‡è¨­æœ€å¾Œä¸€ä½æ˜¯è¦å‰‡ç¢¼
    // åš´è¬¹ä¸€é»æ‡‰è©²å¾å¾Œå¾€å‰æ‰¾ç¬¬ä¸€å€‹è‹±æ–‡å­—æ¯
    
    const rule = ruleTable.find(r => r.cat === cat && r.code.toUpperCase() === code.toUpperCase());
    
    if(!rule) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center; color:red;">ç„¡æ­¤è£½ç¨‹è¦å‰‡ (${cat}-${code})</td></tr>`;
        tfoot.style.display='none';
        return;
    }

    tbody.innerHTML = '';
    const ratio = partRatios[currentPart] || 1.0;
    let totalCost = 0;
    let hasItem = false;

    COMPONENTS.forEach(comp => {
        const timesMultiplier = rule.recipe[comp] || 0; 

        if(timesMultiplier > 0) { 
            hasItem = true;
            
            const kg = (calculatedBaseFormula[comp] || 0) * ratio * timesMultiplier;
            
            let price = 0;
            if(comp === 'é¢æ¼†') {
                price = topcoatCosts[name] || baseCosts['é¢æ¼†'] || 300;
            } else {
                price = baseCosts[comp] || 300;
            }
            
            const cost = kg * price;
            totalCost += cost;
            
            let dispName = comp === "é¢æ¼†" ? `<span class="comp-blue">${name}</span>` : comp;
            
            tbody.innerHTML += `<tr>
                <td>${dispName}</td>
                <td class="highlight-val">${kg.toFixed(3)}</td>
                <td class="cost-val">$${cost.toFixed(1)}</td>
            </tr>`;
        }
    });

    if(!hasItem) { tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;">ç„¡æˆåˆ†</td></tr>`; }
    
    document.getElementById('totalCostDisplay').innerText = '$' + totalCost.toFixed(1);
    tfoot.style.display = 'table-footer-group';
}

/* --- ç®¡ç†ä¸­å¿ƒ --- */
function openManageModal() {
    document.getElementById('manageModal').style.display = 'block';
    modifyingIndex = -1;
    switchTab('tabInput');
    renderInputFields();
    renderCostTable();
    renderHistoryTable();
    renderPaintListTable();
    renderRuleTable();
    renderRatioTable();
    checkMissingRules(); // æª¢æŸ¥ç¼ºå¤±è¦å‰‡
}

function closeModal() { document.getElementById('manageModal').style.display = 'none'; }

function switchTab(id) {
    document.querySelectorAll('.modal-content > div[id^="tab"]').forEach(d => d.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    const btn = document.querySelector(`button[onclick="switchTab('${id}')"]`);
    if (btn) {
        btn.classList.add('active');
    }
}

// æ­·å²æ˜ç´°
function renderHistoryTable() {
    const tbody = document.getElementById('historyTableBody');
    tbody.innerHTML = historicalData.slice().reverse().map((rec, i) => {
        let realIdx = historicalData.length - 1 - i;
        
        let comps = Object.entries(rec.paintUsage).filter(x=>x[1]>0).map(([k,v]) => {
            return `<span class="comp-blue">${k}</span> ${v.toFixed(1)}kg`;
        }).join(', ');
        
        let parts = Object.keys(rec.partProd).map(p => {
            let pr = rec.partProd[p];
            let rw = (rec.partRework && rec.partRework[p]) ? rec.partRework[p] : 0;
            return rw > 0 ? `${p}:${pr}+${rw}é‡` : `${p}:${pr}`;
        }).join(', ');
        
        return `<tr>
            <td>${rec.date}</td>
            <td style="text-align:left;">
                <div>${comps}</div>
                <div style="font-size:12px; color:#666;">${parts}</div>
            </td>
            <td>
                <button onclick="modifyHistory(${realIdx})" style="color:#ff9500; border:none; background:none; cursor:pointer;">ä¿®æ”¹</button>
                <button onclick="deleteHistory(${realIdx})" style="color:red; border:none; background:none; cursor:pointer;">åˆªé™¤</button>
            </td>
        </tr>`;
    }).join('');
}

function modifyHistory(idx) {
    const rec = historicalData[idx];
    modifyingIndex = idx;
    switchTab('tabInput');
    
    document.getElementById('inputDate').value = rec.date;
    selectBatchComponent(rec.componentName);
    document.getElementById('in_paint_total').value = rec.paintUsage[rec.componentName];
    
    renderInputFields();
    setTimeout(() => {
        Object.keys(partRatios).forEach(p => {
            if(rec.partProd[p]) document.getElementById(`in_prod_${p}`).value = rec.partProd[p];
            if(rec.partRework && rec.partRework[p]) document.getElementById(`in_rework_${p}`).value = rec.partRework[p];
            calcReworkRate(p);
        });
    }, 0);
    showStatus("âœï¸ ç·¨è¼¯æ¨¡å¼", "#ff9500");
}

function deleteHistory(idx) {
    if(confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†æ­·å²ç´€éŒ„ï¼Ÿ")) {
        historicalData.splice(idx, 1);
        localStorage.setItem('V35_History', JSON.stringify(historicalData));
        renderHistoryTable();
        recalculateFormula();
    }
}

/* --- æˆæœ¬ç®¡ç† --- */
function renderCostTable() {
    document.getElementById('baseCostBody').innerHTML = COMPONENTS.map(c => {
        if(c === 'é¢æ¼†') return `<tr><td>é¢æ¼† (é è¨­)</td><td><input type="number" value="${baseCosts[c]}" onchange="baseCosts['${c}']=this.value" class="cost-input"></td></tr>`;
        return `<tr><td>${c}</td><td><input type="number" value="${baseCosts[c]}" onchange="baseCosts['${c}']=this.value" class="cost-input"></td></tr>`;
    }).join('');
    
    renderTopcoatCostTable();
}

function renderTopcoatCostTable() {
    document.getElementById('topcoatCostBody').innerHTML = Object.keys(topcoatCosts).map(name => `
        <tr>
            <td class="comp-blue">${name}</td>
            <td>$${topcoatCosts[name]}</td>
            <td><button onclick="deleteTopcoatCost('${name}')" style="color:red; border:none; background:none; font-weight:bold; cursor:pointer;">âœ•</button></td>
        </tr>
    `).join('');
}

function addTopcoatPrice() {
    const name = document.getElementById('costPaintName').value.trim();
    const price = parseFloat(document.getElementById('costPaintPrice').value);
    if(name && price > 0) {
        if (topcoatCosts.hasOwnProperty(name)) {
            showStatus(`âš ï¸ é¢æ¼† ${name} å·²å­˜åœ¨ï¼Œå°‡æ›´æ–°å–®åƒ¹ã€‚`, "#ff9500");
        }
        topcoatCosts[name] = price;
        document.getElementById('costPaintName').value = '';
        document.getElementById('costPaintPrice').value = '';
        renderTopcoatCostTable();
    } else {
        showStatus("âš ï¸ è«‹è¼¸å…¥æœ‰æ•ˆå‹è™Ÿèˆ‡å–®åƒ¹", "red");
    }
}

function deleteTopcoatCost(name) {
    delete topcoatCosts[name];
    renderTopcoatCostTable();
    queryRecipe();
}


/* --- é¢æ¼†æ¸…å–®ç®¡ç† (æ²¿ç”¨) --- */
function renderPaintListTable() {
Â  Â  const tbody = document.getElementById('paintListBody');
Â  Â  tbody.innerHTML = paintList.map(p => `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td class="comp-blue">${p}</td>
Â  Â  Â  Â  Â  Â  <td><button onclick="deletePaint('${p}')" style="color:red; border:none; background:none; cursor:pointer;">âœ•</button></td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');
}

function addPaint() {
Â  Â  const name = document.getElementById('newPaintName').value.trim().toUpperCase();
Â  Â  if(name && !paintList.includes(name)) {
Â  Â  Â  Â  paintList.push(name);
Â  Â  Â  Â  paintList.sort();
Â  Â  Â  Â  document.getElementById('newPaintName').value = '';
Â  Â  Â  Â  renderPaintListTable();
Â  Â  Â  Â  renderQueryControls(); // æ›´æ–° datalist
Â  Â  Â  Â  showStatus("âœ… é¢æ¼†æ–°å¢å®Œæˆ", "green");
Â  Â  } else if (paintList.includes(name)) {
Â  Â  Â  Â  showStatus("âš ï¸ å‹è™Ÿå·²å­˜åœ¨", "red");
Â  Â  }
}

function deletePaint(name) {
Â  Â  if(confirm(`ç¢ºå®šåˆªé™¤é¢æ¼†å‹è™Ÿ ${name} å—ï¼Ÿ`)) {
Â  Â  Â  Â  paintList = paintList.filter(p => p !== name);
Â  Â  Â  Â  renderPaintListTable();
Â  Â  Â  Â  renderQueryControls();
Â  Â  }
}

/* --- è£½ç¨‹è¦å‰‡ç®¡ç† (CRUD) --- */
function renderRuleTable() {
Â  Â  const table = document.getElementById('ruleTable');
Â  Â  let content = '<thead><tr><th>ä»£ç¢¼</th><th>é…æ–¹æˆåˆ†</th><th>æ“ä½œ</th></tr></thead><tbody>';

Â  Â  ruleTable.forEach((r, i) => {
Â  Â  Â  Â  // æ‰¾å‡ºæ‰€æœ‰ç‚º true çš„æˆåˆ†
Â  Â  Â  Â  const activeComps = COMPONENTS.filter(c => r.recipe[c]);
Â  Â  Â  Â  const dispComps = activeComps.map(c => `<span class="comp-blue">${c}</span>`).join(', ');
Â  Â  Â  Â Â 
Â  Â  Â  Â  content += `
Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${r.cat}-${r.code}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>${dispComps || '<span style="color:#aaa;">ç„¡æˆåˆ†</span>'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="editRule(${i})" style="color:#ff9500; border:none; background:none;">ç·¨è¼¯</button>
Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  `;
Â  Â  });
Â  Â Â 
Â  Â  // ç°¡æ˜“æ–°å¢/ç·¨è¼¯å€å¡Š (æ”¾åœ¨è¡¨æ ¼åº•éƒ¨)
Â  Â  content += `
Â  Â  Â  Â  <tr><td colspan="3" style="background:#f9f9fd; padding:15px; border-top:1px solid #ddd;">
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:10px; margin-bottom:10px; align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:600;">ä»£ç¢¼:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="ruleCatInput" placeholder="A, B, C..." style="width:50px; padding:5px; border-radius:4px;"> -
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="ruleCodeInput" placeholder="F, W, Z..." style="width:50px; padding:5px; border-radius:4px;">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="currentRuleIndex" data-index="-1" style="color:red; font-weight:bold;">(æ–°å¢æ¨¡å¼)</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="ruleCompCheckboxes" style="display:flex; flex-wrap:wrap; gap:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  ${COMPONENTS.map(c => `<label><input type="checkbox" data-comp="${c}"> ${c}</label>`).join('')}
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <button onclick="saveRule()" class="btn btn-modify-save" style="margin-top:10px; max-width:150px;">å„²å­˜è¦å‰‡</button>
Â  Â  Â  Â  </td></tr>
Â  Â  `;
Â  Â Â 
Â  Â  content += '</tbody>';
Â  Â  table.innerHTML = content;
}

function editRule(index) {
Â  Â  const r = ruleTable[index];
Â  Â  document.getElementById('ruleCatInput').value = r.cat;
Â  Â  document.getElementById('ruleCodeInput').value = r.code;
Â  Â  document.getElementById('currentRuleIndex').innerText = `(ç·¨è¼¯ #${index})`;
Â  Â  document.getElementById('currentRuleIndex').dataset.index = index;
Â  Â Â 
Â  Â  document.querySelectorAll('#ruleCompCheckboxes input').forEach(input => {
Â  Â  Â  Â  const comp = input.dataset.comp;
Â  Â  Â  Â  input.checked = r.recipe[comp] || false;
Â  Â  });
}

function saveRule() {
Â  Â  const cat = document.getElementById('ruleCatInput').value.trim().toUpperCase();
Â  Â  const code = document.getElementById('ruleCodeInput').value.trim().toUpperCase();
Â  Â  const index = parseInt(document.getElementById('currentRuleIndex').dataset.index);
Â  Â Â 
Â  Â  if(!cat || !code) { showStatus("âš ï¸ è«‹è¼¸å…¥ä»£ç¢¼", "red"); return; }

Â  Â  let newRecipe = {};
Â  Â  document.querySelectorAll('#ruleCompCheckboxes input').forEach(input => {
Â  Â  Â  Â  newRecipe[input.dataset.comp] = input.checked;
Â  Â  });

Â  Â  const newRule = { cat, code, recipe: newRecipe };
Â  Â Â 
Â  Â  if(index >= 0) {
Â  Â  Â  Â  // ç·¨è¼¯ç¾æœ‰
Â  Â  Â  Â  ruleTable[index] = newRule;
Â  Â  } else {
Â  Â  Â  Â  // æ–°å¢æˆ–å–ä»£ç¾æœ‰åŒä»£ç¢¼çš„
Â  Â  Â  Â  const existingIndex = ruleTable.findIndex(r => r.cat === cat && r.code === code);
Â  Â  Â  Â  if(existingIndex !== -1) {
Â  Â  Â  Â  Â  Â  if(!confirm(`ä»£ç¢¼ ${cat}-${code} å·²å­˜åœ¨ï¼Œè¦è¦†è“‹å—ï¼Ÿ`)) return;
Â  Â  Â  Â  Â  Â  ruleTable[existingIndex] = newRule;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  ruleTable.push(newRule);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // æ¸…ç©ºç·¨è¼¯å€
Â  Â  document.getElementById('ruleCatInput').value = '';
Â  Â  document.getElementById('ruleCodeInput').value = '';
Â  Â  document.getElementById('currentRuleIndex').innerText = '(æ–°å¢æ¨¡å¼)';
Â  Â  document.getElementById('currentRuleIndex').dataset.index = -1;
Â  Â  document.querySelectorAll('#ruleCompCheckboxes input').forEach(input => input.checked = false);
Â  Â Â 
Â  Â  renderRuleTable();
Â  Â  showStatus("âœ… è£½ç¨‹è¦å‰‡å·²å„²å­˜", "green");
}

/* --- åŸºæº–å€ç‡ç®¡ç† --- */
function renderRatioTable() {
Â  Â  const tbody = document.getElementById('ratioTableBody');
Â  Â  tbody.innerHTML = Object.keys(DEFAULT_PARTS).map(p => `
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td>${p}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.1" value="${partRatios[p] || 0}" onchange="partRatios['${p}']=parseFloat(this.value)||0;" class="cost-input" style="width:60px;">
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  </tr>
Â  Â  `).join('');
}


/* --- å…¨åŸŸæ“ä½œèˆ‡å„²å­˜ --- */
function saveAllSettings() {
Â  Â  // å„²å­˜æ‰€æœ‰è¨­å®š (ä½¿ç”¨ V35 ç‰ˆæœ¬è™Ÿï¼Œæ–¹ä¾¿æœªä¾†å‡ç´š)
Â  Â  localStorage.setItem('V35_Ratios', JSON.stringify(partRatios));
Â  Â  localStorage.setItem('V35_PaintList', JSON.stringify(paintList));
Â  Â  localStorage.setItem('V35_Rules', JSON.stringify(ruleTable));
Â  Â  localStorage.setItem('V35_BaseCosts', JSON.stringify(baseCosts));
Â  Â  localStorage.setItem('V35_TopcoatCosts', JSON.stringify(topcoatCosts));
Â  Â Â 
Â  Â  renderQueryControls(); // æ›´æ–°æŸ¥è©¢ä»‹é¢
Â  Â  recalculateFormula(); // é‡ç®—é…æ–¹
Â  Â  showStatus("âœ… æ‰€æœ‰è¨­å®šå·²æˆåŠŸå„²å­˜ï¼", "#007aff");
}

function showStatus(message, color) {
Â  Â  const statusDiv = document.getElementById('statusMessage');
Â  Â  statusDiv.innerText = message;
Â  Â  statusDiv.style.color = color;
Â  Â  setTimeout(() => { statusDiv.innerText = ''; }, 3000);
}

// å•Ÿå‹•ç¨‹å¼
init();
</script>
</body>
</html>
